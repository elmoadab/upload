<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ارسال تکالیف</title>
<style>
body { font-family: Arial; background: #4B0082; color: #fff; margin:0; padding:0;}
.container { max-width: 500px; margin: 50px auto; background: #5A2E8C; padding: 20px; border-radius: 10px; }
h1 { text-align:center; color: #FFD700; }
input, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border:none; }
button { background: #FFD700; color: #4B0082; font-weight: bold; cursor:pointer; }
button:hover { opacity:0.9; }
#status a { color: #FFD700; text-decoration: underline; }
</style>
</head>
<body>

<div class="container">
  <h1>ارسال فایل تکلیف</h1>
  <input type="file" id="files" multiple>
  <button onclick="uploadFiles()">آپلود</button>
  <div id="status"></div>
</div>

<script>
const CLOUD_NAME = 'dp72ievec';
const UPLOAD_PRESET = 'my_videos';

const tasks = [
  { title: "تمرین 1", answerType: "text", maxFiles: 1 },
  { title: "تمرین 2", answerType: "video", maxFiles: 2 }
];

const firstName = localStorage.getItem("firstName") || "Student";
const lastName = localStorage.getItem("lastName") || "User";
const taskIndex = localStorage.getItem("currentTask");
const currentTask = tasks[taskIndex];

// تبدیل فاصله و کاراکترهای فارسی
function slugify(text) {
  return text.replace(/\s+/g, "_").replace(/[^\w\-]+/g, "");
}

function uploadFiles() {
  const input = document.getElementById("files");
  const files = input.files;
  if(files.length === 0) { alert("فایلی انتخاب نشده"); return; }
  if(files.length > currentTask.maxFiles) {
    alert(`حداکثر ${currentTask.maxFiles} فایل می‌توانید ارسال کنید`);
    return;
  }

  const status = document.getElementById("status");
  status.innerHTML = "در حال آپلود ...";

  Array.from(files).forEach(file => {
    const reader = new FileReader();
    reader.onload = function(event) {
      const blob = new Blob([event.target.result], { type: file.type });
      const fileName = `${slugify(currentTask.title)}_${slugify(firstName)}_${slugify(lastName)}_${slugify(file.name)}`;
      
      const formData = new FormData();
      formData.append("file", blob, fileName); // نام دلخواه اینجا اعمال می‌شود
      formData.append("upload_preset", UPLOAD_PRESET);

      fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        status.innerHTML += `<br>آپلود موفق: <a href="${data.secure_url}" target="_blank">${file.name}</a>`;
      })
      .catch(err => {
        status.innerHTML += `<br>خطا در آپلود: ${file.name}`;
        console.error(err);
      });
    }
    reader.readAsArrayBuffer(file);
  });
}
</script>

</body>
</html>
