<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>پنل سرگروه — ایجاد تکلیف</title>
  <style>
    :root{
      --bg:#0f0520;--card:#1a0b2b;--accent1:#7b2cbf;--accent2:#b388ff;
      --text:#f5f5ff;--muted:#cfc8e9;--glass: rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box;font-family: "IRANSans", "Vazir", system-ui, -apple-system, "Segoe UI", Roboto, Arial;}
    html,body{height:100%;margin:0;background: linear-gradient(180deg,#0b0317,#140724); color:var(--text);}
    .container{max-width:1100px;margin:28px auto;padding:18px;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:800;color:white;box-shadow:0 10px 30px rgba(123,44,191,0.18);}
    .h1{font-size:20px;font-weight:700;}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015)); padding:16px;border-radius:14px;box-shadow: 0 6px 30px rgba(11,3,23,0.6);border:1px solid rgba(255,255,255,0.03);}
    .form-row{margin-bottom:12px;display:flex;flex-direction:column;gap:6px;}
    label{font-size:13px;color:var(--muted);}
    input[type="text"], input[type="number"], input[type="date"], select, textarea{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:var(--text);outline:none;}
    textarea{min-height:86px;resize:vertical;}
    .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:10px 14px;border-radius:10px;border:none;color:white;font-weight:600;cursor:pointer;box-shadow:0 8px 24px rgba(123,44,191,0.18);}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);}
    .small{font-size:13px;padding:8px 10px;border-radius:8px;}
    .assignment-list{display:flex;flex-direction:column;gap:10px;margin-top:8px;max-height:520px;overflow:auto;padding-right:6px;}
    .assignment-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);}
    .meta{font-size:13px;color:var(--muted);}
    .badge{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-weight:600;}
    .footer-note{font-size:13px;color:var(--muted);margin-top:10px;}
    .row{display:flex;gap:8px;align-items:center;}
    .muted{color:var(--muted);font-size:13px;}
    @media (max-width:920px){.grid{grid-template-columns:1fr;}.container{padding:12px;margin:12px;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <div class="logo">ری</div>
        <div>
          <div class="h1">پنل سرگروه — کلاس ریاضی</div>
          <div style="font-size:13px;color:var(--muted)">ایجاد و مدیریت تکالیف</div>
        </div>
      </div>
      <div class="row">
        <a href="student.html" class="btn small" id="openStudent">صفحهٔ دانش‌آموز</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>ایجاد تکلیف جدید</h3>
        <div class="form-row">
          <label>عنوان تکلیف</label>
          <input id="title" type="text" placeholder="مثال: فصل ۳ — تمرینات" />
        </div>
        <div class="form-row">
          <label>توضیحات (اختیاری)</label>
          <textarea id="description" placeholder="توضیح کوتاه دربارهٔ تکلیف"></textarea>
        </div>
        <div class="form-row">
          <label>نوع پاسخ</label>
          <select id="responseType">
            <option value="text">متنی</option>
            <option value="image">عکس</option>
            <option value="video">ویدیو</option>
            <option value="any">هر نوع فایل</option>
          </select>
        </div>
        <div class="form-row">
          <label>تعداد فایل مجاز (اگر غیر از متنی)</label>
          <input id="numFiles" type="number" min="0" value="1" />
        </div>
        <div class="form-row">
          <label>تاریخ انقضا</label>
          <input id="dueDate" type="date" />
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button id="createBtn" class="btn">ایجاد تکلیف</button>
          <button id="clearBtn" class="btn ghost">پاک کردن فرم</button>
        </div>

        <div class="footer-note">
          تکالیف ایجاد شده در Firestore ذخیره می‌شوند و دانش‌آموزان در صفحهٔ مخصوص خود می‌توانند ارسال کنند.
        </div>
      </div>

      <div class="card">
        <h3>تکالیف فعلی</h3>
        <div id="assignments" class="assignment-list"><div class="muted">در حال بارگذاری…</div></div>
      </div>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>

  <script>
    /***** تنظیمات Cloudinary (از شما) *****/
    const CLOUD_NAME = 'dp72ievec';
    const UPLOAD_PRESET = 'my_videos';

    /***** تنظیمات Firebase — حتماً مقادیر را جایگزین کنید *****/
    // از Firebase Console → Project settings → Your apps
    const FIREBASE_CONFIG = {
      apiKey: "REPLACE_WITH_YOUR_API_KEY",
      authDomain: "REPLACE_WITH_AUTH_DOMAIN",
      projectId: "REPLACE_WITH_PROJECT_ID",
      storageBucket: "REPLACE_WITH_STORAGE_BUCKET",
      messagingSenderId: "REPLACE_WITH_SENDER_ID",
      appId: "REPLACE_WITH_APP_ID"
    };

    // === init firebase ===
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.firestore();

    // === المان‌ها ===
    const titleEl = document.getElementById('title');
    const descEl = document.getElementById('description');
    const respEl = document.getElementById('responseType');
    const numFilesEl = document.getElementById('numFiles');
    const dueDateEl = document.getElementById('dueDate');
    const createBtn = document.getElementById('createBtn');
    const clearBtn = document.getElementById('clearBtn');
    const assignmentsEl = document.getElementById('assignments');

    // === افکت‌ها و عملکردها ===
    createBtn.addEventListener('click', async () => {
      const title = titleEl.value.trim();
      if(!title){ alert('عنوان تکلیف را وارد کنید.'); return; }
      const data = {
        title,
        description: descEl.value.trim(),
        responseType: respEl.value,
        numFiles: Number(numFilesEl.value) || 0,
        dueDate: dueDateEl.value ? new Date(dueDateEl.value).toISOString() : null,
        createdAt: new Date().toISOString()
      };
      try{
        await db.collection('assignments').add(data);
        alert('تکلیف با موفقیت ایجاد شد.');
        titleEl.value=''; descEl.value=''; numFilesEl.value='1'; dueDateEl.value='';
      }catch(err){
        console.error(err); alert('خطا در ذخیره‌سازی تکلیف.');
      }
    });

    clearBtn.addEventListener('click', () => {
      titleEl.value=''; descEl.value=''; numFilesEl.value='1'; dueDateEl.value=''; respEl.value='text';
    });

    // بارگذاری لیست تکالیف
    function renderAssignments(docs){
      assignmentsEl.innerHTML='';
      if(docs.length===0){
        assignmentsEl.innerHTML = '<div class="muted">هیچ تکلیفی وجود ندارد.</div>'; return;
      }
      docs.forEach(doc => {
        const d = doc.data();
        const el = document.createElement('div');
        el.className='assignment-item';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(d.title)}</div>
                          <div class="meta">${d.description?escapeHtml(d.description):''}</div>`;
        const right = document.createElement('div');
        const due = d.dueDate ? new Date(d.dueDate).toLocaleDateString('fa-IR') : 'بدون انقضا';
        right.innerHTML = `<div style="text-align:center"><div class="badge">${escapeHtml(d.responseType)}</div>
                           <div class="meta" style="margin-top:6px">${due}</div>
                           <div style="margin-top:8px" class="row">
                             <button class="btn small" onclick="openSubmissions('${doc.id}')">مشاهده ارسال‌ها</button>
                             <button class="btn ghost small" onclick="deleteAssignment('${doc.id}')">حذف</button>
                           </div></div>`;
        el.appendChild(left); el.appendChild(right);
        assignmentsEl.appendChild(el);
      });
    }

    // مانیتور realtime
    db.collection('assignments').orderBy('createdAt','desc').onSnapshot(snap => {
      renderAssignments(snap.docs);
    });

    // حذف تکلیف
    async function deleteAssignment(id){
      if(!confirm('آیا از حذف تکلیف مطمئن هستید؟')) return;
      try{ await db.collection('assignments').doc(id).delete(); alert('حذف شد'); }
      catch(e){ console.error(e); alert('خطا در حذف'); }
    }
    window.deleteAssignment = deleteAssignment;

    // باز کردن صفحه‌ای برای دیدن ارسال‌ها (ساده: پنجره جدید با لیست)
    function openSubmissions(assignmentId){
      const w = window.open('','_blank');
      w.document.title = 'ارسال‌ها';
      const content = `
        <style>
          body{font-family:Arial;padding:18px;background:#07020a;color:#fff}
          .card{background:#0f0620;padding:12px;border-radius:8px}
          .item{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)}
        </style>
        <h3>ارسال‌ها</h3><div id="list" class="card">در حال بارگذاری...</div>
        <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
        <script>
          const FIREBASE_CONFIG = ${JSON.stringify(FIREBASE_CONFIG)};
          firebase.initializeApp(FIREBASE_CONFIG);
          const db = firebase.firestore();
          const list = document.getElementById('list');
          db.collection('submissions').where('assignmentId','==','${assignmentId}').orderBy('createdAt','desc')
            .onSnapshot(snap => {
              list.innerHTML='';
              if(snap.docs.length===0){ list.innerHTML='<div>هنوز ارسالی وجود ندارد.</div>'; return; }
              snap.docs.forEach(d => {
                const data = d.data();
                const files = (data.files||[]).map(f => '<div><a href="'+f.url+'" target="_blank">'+f.name+'</a></div>').join('');
                const date = new Date(data.createdAt).toLocaleString();
                const html = '<div class="item"><strong>'+escapeHtml(data.studentName || '')+'</strong><div style="color:#cfc8e9;font-size:13px">'+date+'</div>'+files+'</div>';
                list.insertAdjacentHTML('beforeend', html);
              });
            });
          function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];}); }
        <\/script>
      `;
      w.document.body.innerHTML = content;
    }
    window.openSubmissions = openSubmissions;

    // utility
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];}); }
    function sanitize(s){ return s; }
  </script>
</body>
</html>
